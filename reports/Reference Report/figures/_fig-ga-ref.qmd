```{r}
#| label: fig-ga-ref
#| fig-cap: "Distribution of gestational ages of the infants included in this report. A is a histogram in 7-day steps with density curve and B is a boxplot. Vertical lines in the boxplot represent the 25%, 50% and 75% quantiles, the diamond represents the pooled arithmetic mean."

p <- data$patients |>
  dplyr::semi_join(data$enrollments, join_by("patient_key")) |>
  dplyr::mutate(decimal_gestational_age = total_gestation_days / 7)
min_ga <- as.integer(min(p$decimal_gestational_age))
max_ga <- as.integer(max(p$decimal_gestational_age))
week_breaks <- function(x) pretty(x, as.integer((as.integer(x[2]) + 1 - as.integer(x[1])) / 2))
week_labels <- function(x) paste(format(x, big.mark =" "), "w", sep = " ")

gaCombined <- p |>
  ggplot(aes(x = decimal_gestational_age)) +
  geom_histogram(aes(y = after_stat(density)), colour = 1, fill = "white", binwidth = 1, boundary = 3/7, closed = "left") +
  geom_density() +
  scale_x_continuous(breaks = week_breaks) +
  coord_cartesian(xlim = c(min_ga - 1, max_ga + 1)) +
  theme(
    plot.tag = element_text(size = 9),
    axis.title=element_blank(),
    axis.text=element_blank(),
    axis.ticks=element_blank(),
    panel.grid.major.y=element_blank(),
    panel.grid.minor.y=element_blank()) +
  labs(tag = "A")

gaBoxPlot <- p |>
  ggplot(aes(x=factor(0), y = decimal_gestational_age)) +
  geom_boxplot(outlier.shape = NA, coef = 0) +
  stat_summary(fun = "mean", geom = "point", shape = 23, size = 3, fill = "white") +
  scale_y_continuous(breaks = week_breaks, labels = week_labels) +
  coord_flip(ylim = c(min_ga - 1, max_ga + 1)) +
  theme(
    plot.tag = element_text(size = 9),
    axis.title=element_blank(),
    axis.text.y=element_blank(),
    axis.ticks.y=element_blank(),
    panel.grid.major.y=element_blank(),
    panel.grid.minor.y=element_blank()) +
  labs(tag = "B")

gaCombined / gaBoxPlot
```
