```{r}
#| label: tbl-risk-density-rates
#| tbl-cap: "Factors influencing the infants' risk of developing an infection or acquiring a drug-resistant pathogen."
#| tbl-cap-location: top

reference_data |>
  neoipcr::get_usage_density_rate_table() |>
  dplyr::rename(
    "N"="n",
    "Pooled"="pooled",
    "Q₁"="q1",
    "Q₂"="q2",
    "Q₃"="q3") |>
  dplyr::mutate(
    factor = dplyr::case_match(
      as.character(.data$factor),
      "cvc" ~ "CVC",
      "pvc" ~ "PVC",
      "vs" ~ "Any",
      "inv" ~ "INV",
      "niv" ~ "NIV",
      "human_milk" ~ "Human milk",
      "probiotic" ~ "Probiotics",
      "kangaroo_care" ~ "Kangaroo care",
      "ab" ~ "Any antibiotic",
      "a" ~ "Access",
      "w" ~ "Watch",
      "r" ~ "Reserve")) |>
  gt(rowname_col = "factor") |>
  sub_missing() |>
  gt::tab_options(
    latex.use_longtable = TRUE,
    table.width = pct(100),
    table.font.size = 13,
    footnotes.marks = "extended"
  ) |>
  fmt_number(decimals = 1) |>
  fmt_number(columns = "N", decimals = 0) |>
  cols_width(
    stub() ~ pct(25),
    N ~ pct(15),
    Pooled ~ pct(15),
    starts_with("Q") ~ pct(15)
  ) |>
  tab_row_group(label = "Vascular catheter", rows = 1:2, id = "grp_vc") |>
  tab_row_group(label = "Ventilatory support", rows = 3:5, id = "grp_vs") |>
  tab_row_group(label = "Other", rows = 6:8, id = "grp_othr") |>
  tab_row_group(label = "Antibiotics", rows = c("Any antibiotic","Access","Watch","Reserve"), id = "grp_ab") |>
  row_group_order(groups = c("grp_vc", "grp_vs", "grp_ab", "grp_othr")) |>
  tab_spanner(
    label = "Risk Density Rate",
    columns = c("Pooled","Q₁","Q₂","Q₃"),
    id = "risk_density_rate"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(),
      cells_row_groups()
    )
  ) |>
  tab_footnote(
    footnote = md(
      paste0(
        "$$\\text{",
        "Risk Density Rate",
        "} = \\frac{\\text{",
        "Days with risk/protective factor",
        "}}{\\text{",
        "Patient days",
        "}} \\times ",
        format(100, big.mark = locale_sep_mark),
        "$$"
      )),
    locations = cells_column_spanners(spanners = "risk_density_rate")
  ) |>
  tab_footnote(
    footnote = "N: The aggregated number of days the risk/protective factor was present in all infants.",
    locations = cells_column_labels(columns = "N")) |>
  tab_footnote(
    footnote = "Pooled: The Risk Density Rate calculated across all infants from all departments.",
    locations = cells_column_labels(columns = "Pooled")) |>
  tab_footnote(
    footnote = "Q₁, Q₂, Q₃: The quartiles (25%, 50% and 75% quantiles) of the Risk Density Rates of the departments. These quartiles are only displayed when the number of departments contributing to the denominator is greater than or equal to five, and when the median number of device days is greater than or equal to one according to the pooled Risk Density Rate.",
    locations = cells_column_labels(columns = c("Q₁","Q₂","Q₃"))) |>
  tab_footnote(
    footnote = md("WHO AWaRe group (see [aware.essentialmeds.org](https://aware.essentialmeds.org/)). As cumulative treatment days for individual substances are recorded per patient, combination therapies using several substances on one day are counted as multiple days."),
    locations = gt::cells_stub(
      rows = c("Access","Watch","Reserve"))
  )
```
