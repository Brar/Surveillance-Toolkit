```{r}
#| label: tbl-device-associated-incidence-density-rates
#| tbl-cap: "Incidence densities of device-associated infections"
#| tbl-cap-location: top

reference_data |>
  neoipcr::get_dev_ass_incidence_density_rate_table() |>
  dplyr::rename(
    "Device"="dev",
    "N"="n",
    "Pooled"="pooled",
    "Q₁"="q1",
    "Q₂"="q2",
    "Q₃"="q3") |>
  dplyr::mutate(
    Device = dplyr::case_match(
      as.character(.data$Device),
      "cvc" ~ "CVC",
      "pvc" ~ "PVC",
      "vs" ~ "Any ventilatory support",
      "inv" ~ "INV",
      "niv" ~ "NIV")) |>
  gt(rowname_col = "Device") |>
  sub_missing() |>
  gt::tab_options(
    latex.use_longtable = TRUE,
    table.width = pct(100),
    table.font.size = 13,
    footnotes.marks = "extended"
  ) |>
  fmt_number(decimals = 1) |>
  fmt_number(columns = "N", decimals = 0) |>
  cols_width(
    stub() ~ pct(25),
    N ~ pct(15),
    Pooled ~ pct(15),
    starts_with("Q") ~ pct(15)
  ) |>
  tab_row_group(label = "Vascular catheter associated sepsis / bloodstream infection", rows = 1:2, id = "grp_vc") |>
  tab_row_group(label = "Ventilatory support associated pneumonia", rows = 3:5, id = "grp_vs") |>
  row_group_order(groups = c("grp_vc", "grp_vs")) |>
  tab_spanner(
    label = "Device-Associated Incidence Density Rate",
    columns = c("Pooled","Q₁","Q₂","Q₃"),
    id = "da_incidence_density_rate"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(),
      cells_row_groups()
    )
  ) |>
  tab_footnote(
    footnote = md(
      paste0(
        "$$\\text{",
        "Device-Associated Incidence Density Rate",
        "} = \\frac{\\text{",
        "Number of device-associated infections",
        "}}{\\text{",
        "Device days",
        "}} \\times ",
        format(1000, big.mark = locale_sep_mark),
        "$$"
      )),
    locations = cells_column_spanners(spanners = "da_incidence_density_rate")
  ) |>
  tab_footnote(
    footnote = "N: The aggregated number of device-associated infections in all infants.",
    locations = cells_column_labels(columns = "N")) |>
  tab_footnote(
    footnote = "Pooled: The incidence density rate calculated across all infants from all departments.",
    locations = cells_column_labels(columns = "Pooled")) |>
  tab_footnote(
    footnote = "Q₁, Q₂, Q₃: The quartiles (25%, 50% and 75% quantiles) of the Device-Associated Incidence Density Rates of the partner departments. These quartiles are only displayed when the number of departments contributing to the denominator is greater than or equal to five, and when the median number of expected infections is greater than or equal to one according to the pooled Device-Associated Incidence Density Rate.",
    locations = cells_column_labels(columns = c("Q₁","Q₂","Q₃")))
```
