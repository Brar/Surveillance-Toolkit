```{r}
#| label: tbl-surgical-procedure-rates
#| tbl-cap: "Surgical procedures by category"
#| tbl-cap-location: top

tmp <- reference_data |>
  neoipcr::get_surgery_rate_table() |>
  neoipcr::pretty_names()

col_names <- attr(tmp, "names.pretty")
row_names <- attr(tmp, "row.names.pretty")
pro_cat <- col_names[["pro_cat"]]

tmp |>
  gt(rowname_col = pro_cat) |>
  sub_missing() |>
  gt::tab_options(
    latex.use_longtable = TRUE,
    table.width = pct(100),
    table.font.size = 13,
    footnotes.marks = "extended"
  ) |>
  fmt_number(decimals = 1) |>
  fmt_number(columns = col_names[["n"]], decimals = 0) |>
  cols_width(
    matches(pro_cat) ~ pct(50),
    starts_with("Q") ~ pct(7)) |>
  tab_spanner(
    label = "Surgical Procedure Rate",
    columns = c(
      col_names[["pooled"]],
      col_names[["q1"]],
      col_names[["q2"]],
      col_names[["q3"]]),
    id = "procedure_rate"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(),
      cells_column_labels(),
      cells_row_groups()
    )
  ) |>
  tab_footnote(
    footnote = md(
      paste0(
        "$$\\text{",
        "Surgical Procedure Rate",
        "} = \\frac{\\text{",
        "Number of procedures",
        "}}{\\text{",
        "Number of Patients",
        "}} \\times ",
        format(100, big.mark = locale_sep_mark),
        "$$"
      )),
    locations = cells_column_spanners(spanners = "procedure_rate")
  ) |>
  tab_footnote(
    footnote = "N: The aggregated number surgical procedures performed in all infants.",
    locations = cells_column_labels(columns = col_names[["n"]])) |>
  tab_footnote(
    footnote = "Pooled: The Surgical Procedure Rate calculated across all infants from all departments.",
    locations = cells_column_labels(columns = col_names[["pooled"]])) |>
  tab_footnote(
    footnote = paste(paste(col_names[["q1"]],col_names[["q2"]],col_names[["q3"]], sep = ", "), ": The quartiles (25%, 50% and 75% quantiles) of the Surgical Procedure Rates of the partner departments. These quartiles are only displayed when the number of departments contributing to the denominator is greater than or equal to five, and when the median number of procedures is greater than or equal to one according to the pooled Surgical Procedure Rate."),
    locations = cells_column_labels(columns = c(col_names[["q1"]],col_names[["q2"]],col_names[["q3"]])))
```
